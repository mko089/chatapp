services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-chatapp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-chatapp}
      POSTGRES_DB: ${POSTGRES_DB:-chatapp}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  chat-backend:
    image: node:20.19
    working_dir: /workspace/chatapp
    command: >-
      bash -lc "npm install && npm run dev --workspace backend"
    environment:
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY:-dummy}
      LLM_MODEL: ${LLM_MODEL:-gpt-5-mini}
      LLM_MODELS: ${LLM_MODELS:-gpt-5,gpt-5-mini,gpt-4.1-mini,gpt-4o-mini}
      CHAT_MAX_ITERATIONS: ${CHAT_MAX_ITERATIONS:-8}
      PROMPT_TOKEN_COST_USD: ${PROMPT_TOKEN_COST_USD:-0.000005}
      COMPLETION_TOKEN_COST_USD: ${COMPLETION_TOKEN_COST_USD:-0.000015}
      ALLOWED_IPS: ${ALLOWED_IPS:-192.168.2.145,192.168.4.170}
      DATABASE_FILE: ${DATABASE_FILE:-backend/data/chatapp.sqlite}
      POSTGRES_USER: ${POSTGRES_USER:-chatapp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-chatapp}
      POSTGRES_DB: ${POSTGRES_DB:-chatapp}
      POSTGRES_HOST: postgres
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://192.168.14.55:8080}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-garden}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_BACKEND_CLIENT_ID:-chatapp-frontend}
      KEYCLOAK_AUDIENCE: ${KEYCLOAK_AUDIENCE:-chatapp-frontend,account}
      KEYCLOAK_ACCOUNT_CLAIM: ${KEYCLOAK_ACCOUNT_CLAIM:-accountId}
      KEYCLOAK_ROLES_PATH: ${KEYCLOAK_ROLES_PATH:-realm_access.roles|resource_access.chatapp-frontend.roles}
      KEYCLOAK_ENABLED: ${KEYCLOAK_ENABLED:-true}
      AUTH_PUBLIC_PATHS: ${AUTH_PUBLIC_PATHS:-GET /health}
      RBAC_ENABLED: ${RBAC_ENABLED:-true}
      RBAC_DEFAULT_ROLES: ${RBAC_DEFAULT_ROLES:-viewer}
      RBAC_FALLBACK_ROLES: ${RBAC_FALLBACK_ROLES:-viewer}
      RBAC_OWNER_USERS: ${RBAC_OWNER_USERS:-marcin,marcin@garden.local}
      RBAC_UNAUTHENTICATED_MODE: ${RBAC_UNAUTHENTICATED_MODE:-default}
    volumes:
      - ..:/workspace:cached
    ports:
      - "4025:4025"
    depends_on:
      - postgres
    tty: true
    stdin_open: true

  chat-frontend:
    image: node:20.19
    working_dir: /workspace/chatapp
    command: >-
      bash -lc "npm install && npm run dev --workspace frontend"
    environment:
      NODE_ENV: development
      VITE_CHATAPI_URL: ${VITE_CHATAPI_URL:-http://localhost:4025}
      VITE_KEYCLOAK_ENABLED: ${VITE_KEYCLOAK_ENABLED:-true}
      VITE_KEYCLOAK_URL: ${KEYCLOAK_URL:-http://192.168.14.55:8080}
      VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-garden}
      VITE_KEYCLOAK_CLIENT_ID: ${VITE_KEYCLOAK_CLIENT_ID:-chatapp-frontend}
      VITE_KEYCLOAK_SILENT_CHECK_SSO: ${VITE_KEYCLOAK_SILENT_CHECK_SSO:-http://192.168.14.55:4225/silent-check-sso.html}
    ports:
      - "4225:4225"
    volumes:
      - ..:/workspace:cached
    depends_on:
      - chat-backend
    tty: true
    stdin_open: true

volumes:
  postgres-data: {}
