services:
  chat-backend:
    image: node:20.19
    working_dir: /workspace/chatapp
    command: >-
      bash -lc "npm install && npm run build --workspace backend && npm run start --workspace backend"
    environment:
      NODE_ENV: production
      NPM_CONFIG_PRODUCTION: "false"
      OPENAI_API_KEY: ${OPENAI_API_KEY:?set OPENAI_API_KEY}
      LLM_MODEL: ${LLM_MODEL:-gpt-5}
      LLM_MODELS: ${LLM_MODELS:-gpt-5,gpt-5-mini,gpt-5-nano,gpt-4o-mini,gpt-4.1-mini}
      CHAT_MAX_ITERATIONS: ${CHAT_MAX_ITERATIONS:-8}
      PROMPT_TOKEN_COST_USD: ${PROMPT_TOKEN_COST_USD:-0}
      COMPLETION_TOKEN_COST_USD: ${COMPLETION_TOKEN_COST_USD:-0}
      ALLOWED_IPS: ${ALLOWED_IPS:-192.168.2.145,192.168.4.170}
      RBAC_ENABLED: ${RBAC_ENABLED:-true}
      RBAC_OWNER_USERS: ${RBAC_OWNER_USERS:-marcin,marcin@garden.local}
      RBAC_UNAUTHENTICATED_MODE: ${RBAC_UNAUTHENTICATED_MODE:-allow}
      MCP_CONFIG: mcp.config.json
      PORT: 3025
    volumes:
      - ..:/workspace:cached
    ports:
      - '3025:3025'

  chat-frontend:
    image: node:20.19
    working_dir: /workspace/chatapp
    command: >-
      bash -lc "npm install && npm exec -w frontend vite build && npm exec -w frontend vite preview -- --host 0.0.0.0 --port 4173"
    environment:
      NODE_ENV: production
      NPM_CONFIG_PRODUCTION: "false"
      VITE_CHATAPI_URL: ${VITE_CHATAPI_URL:-http://192.168.14.55:3025}
    volumes:
      - ..:/workspace:cached
    ports:
      - '3225:4173'
    depends_on:
      - chat-backend
